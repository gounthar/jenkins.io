---
layout: post
title: "How to remove deprecated plugins from Jenkins while using Docker"
tags:
- jenkins
- docker
- plugins
- jcasc
authors:
- gounthar
opengraph:
  image: /images/post-images/2023/05/16/2023-05-16-jenkins-2023-award-winners/image4.png
discourse: true
---

The Jenkins plugin ecosystem is highly active, and it's not uncommon to come across deprecated plugins.
This can be both positive and negative.
On the positive side, it signifies that the plugin is no longer necessary since its functionality has been integrated into Jenkins core or rendered obsolete by new features or technologies.
On the downside, deprecation could indicate that the plugin is no longer maintained and considered unsafe.

However, removing deprecated plugins from Jenkins when using Docker can be a bit troublesome.
This is due to the way the Jenkins Docker container functions.
Whether you're using the default container or a custom one, it runs on an image that comes with a predefined set of plugins.
Even if you remove these plugins from the Jenkins UI, they are not completely removed from the container.

Now, you might be wondering how this works. Allow me to explain.

## You can't ignore the warning

If your Jenkins instance has deprecated plugins, you'll notice a notification bell in the top right corner.
Clicking on it will display a warning message similar to this:

image::/images/post-images/2023/06/09/2023-06-02-remove-outdated-plugins-while-using-docker/the-following-plugins-are-deprecated.png[width=839,deprecated plugins warning]

It suggests you to click on **Manage Jenkins** to remove the deprecated plugins.
Once in **Manage Jenkins**, you can't (once more) ignore the warning:

image::/images/post-images/2023/06/09/2023-06-02-remove-outdated-plugins-while-using-docker/the-following-plugins-are-deprecated-once-more.png[width=839,deprecated plugins warning once again]

It's a clear indication that we need to take action to address this situation.

## Removing deprecated plugins in the UI

Follow these steps to remove the deprecated plugin:

1. Click on *Plugins*, then select *Installed plugins*.
2. In the search box, enter the name of the deprecated plugin (in this case, it's `popper`).

image::/images/post-images/2023/06/09/2023-06-02-remove-outdated-plugins-while-using-docker/popper-can-t-be-uninstalled.png[width=839,search for the deprecated plugin]

Unfortunately, we encounter an issue as we are unable to uninstall it.
The checkmark is greyed out, and the *Uninstall* button (red cross) is disabled.
Why is that?
Some plugins have dependencies on other plugins, which in turn have dependencies on further plugins, creating a chain of dependencies.
When you put your mouse pointer over the red cross, you'll see a tooltip that indicates the parent plugin blocking the uninstallation:

image::/images/post-images/2023/06/09/2023-06-02-remove-outdated-plugins-while-using-docker/who-is-my-daddy.png[what is the parent plugin blocking the uninstallation?]

In this case, `popper` is a dependency for another plugin called `bootstrap4-api`.
Therefore, we need to remove `bootstrap4-api` first and then proceed with `popper`.

Back to the [.line-through]#drawing board# search box, this time with `bootstrap4-api`.

image::/images/post-images/2023/06/09/2023-06-02-remove-outdated-plugins-while-using-docker/bootstrap4-can-be-uninstalled.png[width=839,search for the parent plugin]

This time, we can uninstall it by clicking on the red cross.
We will then have a warning message saying:

> You are about to uninstall the Bootstrap 4 API Plugin plugin.
This will remove the plugin binary from your $JENKINS_HOME, but it will leave the configuration files of the plugin untouched.

image::/images/post-images/2023/06/09/2023-06-02-remove-outdated-plugins-while-using-docker/remove-the-plugin-binary.png[width=839,remove the plugin binary]

Really? We'll check that later. Click on **Yes** to proceed with the uninstallation.
And we're back to the Installed plugins page.
Let's give another chance to popper by searching for it again:

image::/images/post-images/2023/06/09/2023-06-02-remove-outdated-plugins-while-using-docker/popper-can-be-uninstalled.png[width=839,popper can be uninstalled now]

Same player, shoot again. Follow the same steps as before to uninstall `popper`.
After successfully uninstalling popper, you may notice that the notification icon still displays a message.
Furthermore, if we go back to the **Installed plugins** page, we'll see that `popper` is still there.

image::/images/post-images/2023/06/09/2023-06-02-remove-outdated-plugins-while-using-docker/pending-uninstallation.png[width=839,pending uninstallation]

Why is this the case?
We asked for uninstallation, but it didn't fully happen. Jenkins has to restart in order to complete the process.
You can hit the `/safeRestart` endpoint to restart Jenkins safely and then click **Yes**.
When you return, you will notice that the notification icon has disappeared, and the plugin is no longer listed on the Installed plugins page.

## Removing deprecated plugins in the docker context

However, depending on your Jenkins configuration, you may find that the deprecated plugins have somehow reappeared in your Jenkins instance, sometimes even with an older version.
How is this possible?
If your Jenkins container instance inherits from the Jenkins official container, it comes with a predefined set of plugins.
Most of the time, these plugins won't be enough for your specific use case.
You will need to install additional plugins.
When you do so, the new plugins will be installed in the `$JENKINS_HOME/plugins` directory, with a command such as:

[source,dockerfile]
----
COPY --chown=jenkins:jenkins ./plugins.txt /usr/share/jenkins/plugins.txt
RUN jenkins-plugin-cli --plugin-file=/usr/share/jenkins/plugins.txt
----

So...
Whenever you remove a deprecated plugin from the Jenkins UI, remember to also remove it from the Docker context.
Otherwise, it will be reinstalled when you rebuild the container.
In my case, I had to remove the following plugins from the `plugins.txt` file:

[source,dockerfile]
----
# See https://github.com/jenkinsci/docker#usage-1
ant:487.vd79d090d4ea_e
[...]
bootstrap4-api:4.6.0-3
[...]
popper-js:2.9.2-1
[...]
ws-cleanup:0.45
----

Now you're safe for the next time you rebuild your Jenkins container.
But what about your running container? Is it free of any reference to the deprecated plugins?
Let's find out.

## Removing deprecated plugins from the running container

Here is an excerpt of my `docker-compose.yml` file:

[source,dockerfile]
----
#  docker compose up -d --build --force-recreate
services:
    jenkins:
        build: ./controller
        restart: always
        ports:
            - "8080:8080"
            - "50000:50000"
        volumes:
            - jenkins-data:/var/jenkins_home:rw
            - ./casc.d:/var/jenkins_home/casc.d/:ro
        environment:
            - CASC_JENKINS_CONFIG=/var/jenkins_home/casc.d/
[...]
volumes:
    jenkins-data:
----

The `jenkins-data` volume is mounted on the `/var/jenkins_home` directory of the container.
However, the `/usr/share/jenkins/plugins.txt` file, as we saw earlier in the `Dockerfile`, is not mounted on a shared volume.

To find the running container ID that will allow us to search for traces of the deprecated plugins, we need to look for a container with a name containing `jenkins` and that exposes port `8080`:

[source,bash]
----
 docker ps | grep jenkins |grep 8080
88bdae0df4da   jenkins-jenkins                                                         "/usr/bin/tini -- /uâ€¦"   3 hours ago    Up 2 hours             0.0.0.0:8080->8080/tcp, 0.0.0.0:50000->50000/tcp           jenkins-jenkins-1
----

There we go.
I happen to have installed `bash` in my container, so I can run the following command to get a shell in the container:

[source,bash]
----
docker exec -it 88bdae0df4da bash
----

You could do the same with `sh` if `bash` was not installed in your Docker image.
Now, let's search for the plugins definition file.
As we've seen in the Dockerfile, it's located in `/usr/share/jenkins/plugins.txt`:

[source,bash]
----
cd /usr/share/jenkins
cat plugins.txt |grep bootstrap4-api
bootstrap4-api:4.6.0-3
----

The reference to the deprecated plugin is still there.
Is that a problem?
No. As the link:https://github.com/jenkinsci/docker#usage-1[documentation] says:

> When jenkins container starts, it will check JENKINS_HOME has this reference content, and copy them there if required. It will not override such files, so if you upgraded some plugins from UI they won't be reverted on next start.

So it's there, but it won't do any harm, it won't be used.
Let's leave it there, until the next time we rebuild the container, as we have already cleaned up the `plugins.txt` file used by the Docker context earlier.

Now what? Let's have a look at the `$JENKINS_HOME` directory.

[source,bash]
----
cd $JENKINS_HOME
find . -name plugins.txt
----

Nothing. We don't have a `plugins.txt` file in the `$JENKINS_HOME` directory.
Fine.
What else?
Can we find any remaining trace of the deprecated plugins?
I'm afraid we can.

[source,bash]
----
find . -name bootstrap4*
./plugins/bootstrap4-api
./plugins/bootstrap4-api/META-INF/maven/io.jenkins.plugins/bootstrap4-api
./plugins/bootstrap4-api/WEB-INF/lib/bootstrap4-api.jar
./plugins/bootstrap4-api.bak
./plugins/bootstrap4-api.jpi
./plugins/bootstrap4-api.jpi.version_from_image
./plugins/bootstrap4-api.jpi.pinned
----

There are still some traces of the `bootstrap4-api` deprecated plugin in the `$JENKINS_HOME/plugins` directory.
What about the `popper-js` plugin?
It's there too.
It may explain why despite having removed the deprecated plugins from the Jenkins UI, they were still there when we rebuilt the container.
Let's remove them for real this time:

[source,bash]
----
rm -rf ./plugins/bootstrap4-api*
rm -rf ./plugins/popper*
----

We can now safely exit the container, and restart it from the UI by hitting the `/safeRestart` endpoint.
When we return, we can check that the deprecated plugins are no longer there.