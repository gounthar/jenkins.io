---
layout: post
title: "Android and Jenkins: what is the limit? Part two."
tags:
- jenkins
- android
- aarch64
- termux
authors:
- gounthar
opengraph:
  image: /images/post-images/2023/03/29/2023-03-22-android-and-jenkins/love.png
discourse: true
---

image:/images/post-images/2023/03/29/2023-03-22-android-and-jenkins/love.png[jenkins hugging bugdroid,500]

I know it's been over a year since link:/blog/2023/03/30/android-and-jenkins/[the first article] of this series, but hey, life happens!
I've been juggling quite a few things that are more important for the Jenkins project.
Let's face it, nobody's losing sleep over running Jenkins on Android.
But hey, sometimes you just gotta indulge in a bit of tech whimsy, am I right?

So, here we are, diving back into this almost frivolous experiment to see just how far we can push the Jenkins-Android interaction.
There are essentially two ways to stretch the boundaries with Jenkins and Android:

. Building Android apps with Jenkins
. Running Jenkins on an Android device

Now, the first option has already had its moment in the spotlight in another series of articles, so we're turning our attention to the latter.
Why, you might ask?
Well, because why not? Because we're tech enthusiasts, and if there's a crazy idea floating around, we're going to give it a shot!

== Setting up Jenkins Controller on Android

In link:/blog/2023/03/30/android-and-jenkins/[the previous article], we already laid the groundwork for running a Jenkins agent on Android.
We installed link:https://wiki.termux.com/[Termux], link:https://www.openssh.com/[OpenSSH], and link:/blog/2023/03/30/android-and-jenkins/#installing-java-on-termux[Java] on the Android device, and confirmed that the agent could be reached from a grown-up Jenkins controller.
We even got it to run a FreeStyle pipeline that spat out the result of the `uname -a` command. +
Quite the achievement, huh?

For this experiment, we're sticking with my old Redmi Note 7, still chugging along with Android 10.
Now, keep in mind, this device got benched because it couldn't keep up with my daily pace, so it's not exactly a powerhouse for Jenkins.
Sure, I could've slapped Linux on it instead, but where's the fun in taking the easy route, right?
Let's see if we can kickstart a Jenkins controller on this bad boy!

=== Launching the controller via Java command.

Now, I've dabbled with memory-constrained devices before, and I know a Jenkins controller can work with a measly 1GB of RAM.
No clue how much of that sweet memory pie the Android system will serve up to Termux, or how much Termux will pass along to the JVM, but hey, let's roll the dice!
When I SSH in from my PC, here's what I see:

[source,bash]
----
~ $ free -h
               total        used        free      shared  buff/cache   available
Mem:           3.6Gi       2.1Gi        80Mi       3.0Mi       1.5Gi       1.3Gi
Swap:          2.2Gi       1.6Gi       623Mi
----

Looks like we're sitting on a cozy 3.6GB of RAM, which should be just about enough to wrangle a Jenkins controller into submission.
Let's fire it up using the trusty jenkins.war file, the lazy dev's best friend! +
But first, a quick pit stop to grab the latest LTS version of Jenkins from link:https://get.jenkins.io/war-stable/latest/jenkins.war[here]. +
link:/download/#downloading-jenkins[The official documentation] says it's `2.440.3` at the time of writing, but, you know, details.

[source,bash]
----
pkg install curl
----
Now, with our newfound love for curl, let's snag that jenkins.war file:

[source,bash]
----
curl -L -O https://get.jenkins.io/war-stable/latest/jenkins.war
----

With the file safely in our grasp, it's showtime! Let's unleash Jenkins upon this unsuspecting Android device:

[source,bash]
----
java -jar jenkins.war
----

The familiar lines start flowing:

[source,bash]
----
~ $ java -jar jenkins.war
Running from: /data/data/com.termux/files/home/jenkins.war
webroot: /data/data/com.termux/files/home/.jenkins/war
2024-04-11 11:37:23.764+0000 [id=1]     INFO    winstone.Logger#logInternal: Beginning extraction from war file
2024-04-11 11:37:24.486+0000 [id=1]     WARNING o.e.j.s.handler.ContextHandler#setContextPath: Empty contextPath
2024-04-11 11:37:24.546+0000 [id=1]     INFO    org.eclipse.jetty.server.Server#doStart: jetty-10.0.20; built: 2024-01-29T20:46:45.278Z; git: 3a745c71c23682146f262b99f4ddc4c1bc41630c; jvm 17-internal+0-adhoc..src
2024-04-11 11:37:24.804+0000 [id=1]     INFO    o.e.j.w.StandardDescriptorProcessor#visitServlet: NO JSP Support for /, did not find org.eclipse.jetty.jsp.JettyJspServlet
2024-04-11 11:37:24.848+0000 [id=1]     INFO    o.e.j.s.s.DefaultSessionIdManager#doStart: Session workerName=node0
2024-04-11 11:37:25.418+0000 [id=1]     INFO    hudson.WebAppMain#contextInitialized: Jenkins home directory: /data/data/com.termux/files/home/.jenkins found at: $user.home/.jenkins
2024-04-11 11:37:25.844+0000 [id=1]     INFO    o.e.j.s.handler.ContextHandler#doStart: Started w.@7d199c68{Jenkins v2.440.2,/,file:///data/data/com.termux/files/home/.jenkins/war/,AVAILABLE}{/data/data/com.termux/files/home/.jenkins/war}
2024-04-11 11:37:25.855+0000 [id=1]     INFO    o.e.j.server.AbstractConnector#doStart: Started ServerConnector@2f4205be{HTTP/1.1, (http/1.1)}{0.0.0.0:8080}
2024-04-11 11:37:25.872+0000 [id=1]     INFO    org.eclipse.jetty.server.Server#doStart: Started Server@32811494{STARTING}[10.0.20,sto=0] @2832ms
2024-04-11 11:37:25.874+0000 [id=26]    INFO    winstone.Logger#logInternal: Winstone Servlet Engine running: controlPort=disabled
2024-04-11 11:37:26.135+0000 [id=34]    INFO    jenkins.InitReactorRunner$1#onAttained: Started initialization
2024-04-11 11:37:26.150+0000 [id=43]    INFO    jenkins.InitReactorRunner$1#onAttained: Listed all plugins
2024-04-11 11:37:26.965+0000 [id=32]    INFO    jenkins.InitReactorRunner$1#onAttained: Prepared all plugins
2024-04-11 11:37:26.970+0000 [id=33]    INFO    jenkins.InitReactorRunner$1#onAttained: Started all plugins
2024-04-11 11:37:26.976+0000 [id=39]    INFO    jenkins.InitReactorRunner$1#onAttained: Augmented all extensions
2024-04-11 11:37:27.218+0000 [id=44]    INFO    jenkins.InitReactorRunner$1#onAttained: System config loaded
2024-04-11 11:37:27.219+0000 [id=44]    INFO    jenkins.InitReactorRunner$1#onAttained: System config adapted
2024-04-11 11:37:27.219+0000 [id=44]    INFO    jenkins.InitReactorRunner$1#onAttained: Loaded all jobs
2024-04-11 11:37:27.221+0000 [id=44]    INFO    jenkins.InitReactorRunner$1#onAttained: Configuration for all jobs updated
2024-04-11 11:37:27.261+0000 [id=58]    INFO    hudson.util.Retrier#start: Attempt #1 to do the action check updates server
2024-04-11 11:37:27.567+0000 [id=42]    INFO    jenkins.install.SetupWizard#init:

*************************************************************
*************************************************************
*************************************************************

Jenkins initial setup is required. An admin user has been created and a password generated.
Please use the following password to proceed to installation:

12023083cbcf4c33a8ddba2801332526

This may also be found at: /data/data/com.termux/files/home/.jenkins/secrets/initialAdminPassword

*************************************************************
----

The web page is also looking familiar, except for the path where the password is stored:

image:/images/post-images/2024/04/18/unlock-jenkins.png[standard first Jenkins screen,860]

All seems well, until Jenkins throws a tantrum about the absence of a /tmp dir:

[source,bash]
----
/tmp does not exist.
----

Minor hiccup aside, the installation chugs along smoothly, and the default plugins find their cozy little corner.

image:/images/post-images/2024/04/18/plugins-install.png[standard plugins install,860]

The journey nears its end, punctuated by the customary security warning about the use of the built-in node.
image:/images/post-images/2024/04/18/security-issue.png[standard security warning,860]
Nothing to do with Termux, but we'll iron out the kinks later.

Quite the milestone, huh? +
We've proven that we can kickstart a Jenkins controller using Termux on an Android device. +
But hold onto your hats, folks!
We're not done just yet. +
Next up, we'll ensure this Jenkins controller can strut its stuff as a service, and then, we'll tweak it to kick off automatically at boot time.

=== What is a service, and why do we need it?

Now, we could just let Jenkins lurk in the shadows, but where's the fun in that?
What if Android decides to play the ultimate prank and terminate Termux, or the device throws a fit and decides to reboot?
We'd be stuck manually resurrecting Jenkins every single time, and that's just not the cricket we signed up for. +
So, let's give Jenkins a promotion, shall we? Time to turn it into a proper service!

The standard Jenkins installation link:/blog/2022/03/25/systemd-migration/[migrated] from `init` to `systemd` a while back.
Unfortunately, Termux isn't in on the `systemd` party, so we'll have to make do with the tools it offers. +
Enter link:https://wiki.termux.com/wiki/Termux-services[termux-services], a handy collection of scripts for service wrangling. +
Instead of cluttering up `~/.bashrc` or `~/.bash_profile`, we can now start and stop services with a flick of the wrist, thanks to termux-services. +
There's already a smorgasbord of existing services ready to roll, and just like with `systemd`, there's nothing stopping us from crafting a bespoke service for our beloved Jenkins.

To get termux-services up and running, execute:

[source,bash]
----
pkg install termux-services runit
service-daemon start
----
Then, give Termux a gentle nudge so that the service-daemon springs to life.

[source,bash]
----
exit
----

Next up, to unleash the power of a service, fire off:
[source,bash]
----
sv-enable <service>
----
If you're in the mood for a one-off joyride, a simple:
[source,bash]
----
sv up <service>
----
will suffice. +
And when it's time to hit the brakes, just tap into your inner traffic cop with:
[source,bash]
----
sv down <service>
----
Or, if you're feeling particularly ruthless, disable it altogether:
[source,bash]
----
sv-disable <service>
----
A service is like a restless spirit shackled to this mortal realm if `$PREFIX/var/service/<service>/down` exists, so the `sv-enable` and `sv-disable` scripts play a little game of touch-and-go with this file.

Under the hood, termux-services taps into the mighty link:http://smarden.org/runit/[runit] to reign in the chaos of services. +
You'll find a treasure trove of example scripts on the link:http://smarden.org/runit/runscripts.html[runit website]. +
If you spot a script you fancy, or if you're feeling particularly creative, just follow these steps:
[source,bash]
----
mkdir -p $PREFIX/var/service/<PKG>/log
ln -sf $PREFIX/share/termux-services/svlogger $PREFIX/var/service/<PKG>/log/run
----
Then, tuck your run script snugly into `$PREFIX/var/service/<PKG>/run`, making sure it's ready for its close-up.

With all the pieces in place, a swift:
and then put your run script for the package at `$PREFIX/var/service/<PKG>/run` and make sure that it is runnable.

You can then run
[source,bash]
----
sv up <PKG>
----
will breathe life into your creation.

The log files for these services bask in the limelight at `$PREFIX/var/log/sv/<PKG>/`, with the star of the show bearing the name "current".

=== Turning Jenkins into a Service for Smooth Sailing

Now that we've mastered the art of creating and deploying services with Termux, let's give our Jenkins controller a promotion. +
First up, we need to whip up a script to kickstart Jenkins as a service.
Let's call it `run` and tuck it snugly into the `$PREFIX/var/service/jenkins/` directory.

[source,bash]
----
mkdir -p $PREFIX/var/service/jenkins
cd $PREFIX/var/service/jenkins
cat >> run <<EOF
#!/data/data/com.termux/files/usr/bin/bash
JENKINS_LOG=/data/data/com.termux/files/home/.jenkins/logs/jenkins.log
/data/data/com.termux/files/usr/bin/java -Djava.io.tmpdir=/data/data/com.termux/files/usr/tmp -jar /data/data/com.termux/files/home/jenkins.war --logfile=${JENKINS_LOG}
EOF
chmod +x run
mkdir -p /data/data/com.termux/files/home/.jenkins/logs
touch /data/data/com.termux/files/home/.jenkins/logs/jenkins.log
----

With our script ready, let's test if Jenkins plays nice as a service:
[source,bash]
----
sv-enable jenkins
sv up jenkins
----

Time to peek under the hood and see if Jenkins is revving up by checking the logs:
[source,bash]
----
tail -f $PREFIX/../home/.jenkins/logs/jenkins.log&
----

Voilà! Standard Jenkins logs, just like we're accustomed to seeing on a run-of-the-mill server.
[source,bash]
----
2024-04-18 14:13:27.380+0000 [id=1]     WARNING o.e.j.s.handler.ContextHandler#setContextPath: Empty contextPath
2024-04-18 14:13:27.446+0000 [id=1]     INFO    org.eclipse.jetty.server.Server#doStart: jetty-10.0.20; built: 2024-01-29T20:46:45.278Z; git: 3a745c71c23682146f262b99f4ddc4c1bc41630c; jvm 17-internal+0-adhoc..src
2024-04-18 14:13:27.727+0000 [id=1]     INFO    o.e.j.w.StandardDescriptorProcessor#visitServlet: NO JSP Support for /, did not find org.eclipse.jetty.jsp.JettyJspServlet
2024-04-18 14:13:27.780+0000 [id=1]     INFO    o.e.j.s.s.DefaultSessionIdManager#doStart: Session workerName=node0
2024-04-18 14:13:28.355+0000 [id=1]     INFO    hudson.WebAppMain#contextInitialized: Jenkins home directory: /data/data/com.termux/files/home/.jenkins found at: $user.home/.jenkins
2024-04-18 14:13:28.524+0000 [id=1]     INFO    o.e.j.s.handler.ContextHandler#doStart: Started w.@216914{Jenkins v2.440.3,/,file:///data/data/com.termux/files/home/.jenkins/war/,AVAILABLE}{/data/data/com.termux/files/home/.jenkins/war}
2024-04-18 14:13:28.538+0000 [id=1]     INFO    o.e.j.server.AbstractConnector#doStart: Started ServerConnector@395b56bb{HTTP/1.1, (http/1.1)}{0.0.0.0:8080}
2024-04-18 14:13:28.570+0000 [id=1]     INFO    org.eclipse.jetty.server.Server#doStart: Started Server@13f17eb4{STARTING}[10.0.20,sto=0] @2771ms
----

With Jenkins now up and about, you can access it at the port 8080 on your trusty Android device.
image:/images/post-images/2024/04/18/jenkins-home.png[standard Jenkins home page,860]

=== Ensuring Availability from Boot for Uninterrupted Service

We've hit two major milestones:

. Getting a Jenkins controller up and running on an Android device.
. Successfully running Jenkins as a service on the Android device whenever we fire up Termux.

Pretty cool, right? +
But what if the device decides to throw a curveball and reboots?
I know, this whole experiment is just a tech whimsy, but let's push the boundaries and see how far we can take it.
Frankly, even if I'm just treating this as a fun experiment, I'd rather not deal with the hassle of launching Termux every time I reboot the device. +
So, the logical next step?
Adding the Jenkins service to the roster of auto-starting services when the device boots up.

==== Installation of Termux:Boot

First things first, let's get our hands on the Termux:Boot add-on from link:https://f-droid.org/packages/com.termux.boot/[F-Droid].
Important note: Keep your installations of Termux and Add-ons strictly from one source, either Google Play or F-Droid.
Mixing them up can lead to compatibility issues due to different key-signing methods.

. Install the Termux:Boot app.
. Head over to your Android settings and give Termux and Termux:Boot the green light by turning off battery optimizations for these apps.
. Give the Termux:Boot app a friendly tap to start it up.
This ensures it gets the memo to kick into action at boot time.
. Ready for some directory magic?
Let's create the `~/.termux/boot/` directory: This is where you'll stash all the scripts you want to fire up on boot.
[source,bash]
----
mkdir ~/.termux/boot/
----
If you've got a bunch of scripts, fear not—they'll line up and execute in a nice, orderly fashion.
. Pro tip: Keep your device wide awake by running termux-wake-lock right off the bat.
For example, to kickstart an sshd server and keep your device bright-eyed and bushy-tailed at boot, craft a little script like this one at `~/.termux/boot/start-sshd`:
[source,bash]
----
#!/data/data/com.termux/files/usr/bin/sh
termux-wake-lock
sshd
----
Don't you forget to make it executable:
[source,bash]
----
chmod 755 ~/.termux/boot/start-sshd
----
And if you're itching to have Termux-services do their thing at boot time, simply throw in:
[source,bash]
----
#!/data/data/com.termux/files/usr/bin/sh
termux-wake-lock
. $PREFIX/etc/profile
----
This nifty snippet will unleash all the services that are raring to go in termux-services.

==== Adding Jenkins to the list of services that start automatically

Now, let's add Jenkins to the list of services that start automatically when the device boots up.
Craft a script named `~/.termux/boot/start-jenkins` and give it the following content:
[source,bash]
----
#!/data/data/com.termux/files/usr/bin/sh
termux-wake-lock
sv up jenkins
----

And there you have it!
Jenkins is now part of the elite club of services that kick off automatically when the device boots up.
Now, you can rest easy knowing that your Jenkins controller will be up and running, ready to tackle any task you throw its way.

==== Checking Jenkins' Boot-up Performance

To ensure that Jenkins is indeed strutting its stuff when the device boots up, let's put it to the test—give that device a good old reboot. +
But before you hit that restart button, make sure you've given termux-boot a hearty handshake at least once and sorted out all the necessary permissions. +
That means letting it run in the background and disabling battery optimization.
And if you're rocking a phone with MIUI, well, hold onto your hats—you might need to do a little extra dance to get things grooving smoothly. +
Head on over to the settings, and summon the magic word "background".
Hunt down an item called "Background autostart" and flip the switch for termux-boot and termux. +
Et voilà! You've just unleashed the boot-time prowess of termux on MIUI.

== Adding a Jenkins Agent on Android

We've seen earlier that Jenkins on Android behaves like a champ, but that should not make us forget about our duties.
Jenkins is complaining about the absence of an agent, and we can't just ignore it.
image:/images/post-images/2024/04/18/jenkins-complaining.png[Jenkins complaining about the absence of an agent,860]
So, let's roll up our sleeves and get an agent up and running on Android.

=== Establishing SSH connection for agent integration.

In our previous article, we link:/blog/2023/03/30/android-and-jenkins/#setting-up-public-key-authentication[created an SSH key pair] so we can log in without a password on our Android device.
Let's create another key pair for the agent, and add the public key to the `~/.ssh/authorized_keys` file on the Android device.
Through ssh or directly on the Android device, enter the following commands:
[source,bash]
----
~ $ ssh-keygen -t rsa -b 4096 -C "jenkins-agent"
Enter file in which to save the key (/data/data/com.termux/files/home/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /data/data/com.termux/files/home/.ssh/id_rsa
Your public key has been saved in /data/data/com.termux/files/home/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:rpaD/RohRXJsXAYTOahQWpIsih9vhzgl7G9PO23MujI jenkins-agent
The key's randomart image is:
+---[RSA 4096]----+
|ooo .+*=o        |
|+=  .+*o         |
|=o . ...         |
|o = ..           |
| o *... S        |
|  = +..o         |
|   + +o=.        |
|    E.*+=        |
|   . =BO.        |
+----[SHA256]-----+
~ $ cat ~/.ssh/id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCb+j8eUrnWLh4DWSY8C9t5iNa9AtcIn2oShDUi4ATLKcyPINAmCcDVw19uzhFd+J836iKEFScx9Qw7zuv9iNWEjxEERXyFHXt8A9lMf78aeK4dvDei60JEN5+28YO7ctlQ39+wzHXIMtrFiBTeIFpIjPqM1EskKqTq8ySty+TrozCySXnFgbceP9NN+AcaqdQL2skw0Hc7NyER9qG7voZ7UwSbD2g7w1LFr+TX2i8ew8BX8D9tiE86BOYC4HyRiVN50GAUtdRhUPCY+DvCPwSY+3bjUk2VTY+ibo9vIToshCNPbR0AwIAZqVSas2qe9Tn9QFW/Q+cA8PQKJ9AAFWgz3RMzWPxFG7H+CFsvvJSxagF0zk4UtidYa02fLlOpsGNNvxHAQTWjbWBLhb2Sh1RnOIEefC7cheNvwtS81OXqLuhKJqzDkW3d4jVl1ukVjKeT+UVOXw/gmNlFr3sho83nLdtxKnatfwRKaAkH2p6mtZzwMgPtA3wHM3iUo26i/RhVjliu+OZVdHIWCteBKhgylBVjGT2YPT4nHvsczSjM607xKke6+KZSzqyoYpjgMgYVtUTMSbnggFuWxfQms9a7tBLqv2GJzLoYJnWajXtrRokctQ/JyRFCZND7zhCF4cjyoI505tRgBUp7E3KV7CYiETV+7gQ92dV7K9Lf0u0OVQ== jenkins-agent
----


=== Configuring the agent to communicate with the controller.

Let's click on the blue button "Set up agent" and follow the instructions.
image:/images/post-images/2024/04/18/set-up-agent.png[Jenkins asking to set up an agent,860]
Add a node name (I chose "Myself" because the agent will be on the Android machine too), and select "Permanent Agent" as the mode.

== Creating a Pipeline from GitHub Repo
=== Setting up a pipeline to automate tasks.
=== Linking the pipeline to a GitHub repository for version control.
== Conclusion
=== Reflecting on the process and achievements.
=== Teasing a funny opening for the next adventure.
=== Bonus: Funny Opening

